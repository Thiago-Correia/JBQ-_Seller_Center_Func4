<div class="app">
  <aside class="sidebar">
    <h2>Painel de Controle</h2>
    <ul>
      <li><i class="fa-solid fa-plus"></i> Cadastrar produtos</li>
      <li><i class="fa-solid fa-list"></i> Lista de produtos</li>
      <li><i class="fa-solid fa-tag"></i> Alterar pre√ßos</li>
      <li class="active"><i class="fa-solid fa-check"></i> Verificar produtos</li>
      <li><i class="fa-solid fa-box"></i> Gerir estoque</li>
      <li class="logout"><i class="fa-solid fa-right-from-bracket"></i> Log out</li>
    </ul>
  </aside>

  <main class="content">
    <div class="container">
      <h1 class="titulo">Pedidos</h1>

      <div class="tabela-container">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Cliente</th>
              <th>Total</th>
              <th>Status</th>
              <th>Data</th>
              <th class="center">A√ß√µes</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let p of pedidos" class="row">
              <td>{{ p.id }}</td>
              <td>{{ p.clienteNome }}</td>
              <td>R$ {{ p.total.toFixed(2) }}</td>
              <td>{{ p.status }}</td>
              <td>{{ formatarData(p.dataPedido) }}</td>
              <td class="center">
                <button class="btn icon" (click)="abrirDetalhes(p)">üëÅ</button>
              </td>
            </tr>
          </tbody>
        </table>

        <div class="modal-overlay" *ngIf="selectedPedido">
          <div class="modal">
            <div class="modal-header">
              <h2>Pedido #{{ selectedPedido.id }}</h2>
              <button class="btn-close" (click)="fecharDetalhes()">‚úñ</button>
            </div>

            <!-- üî• NAV DAS ABAS -->
            <div class="modal-tabs">
              <button
                class="tab-btn"
                [class.active]="abaAtiva === 'detalhes'"
                (click)="abaAtiva = 'detalhes'"
              >
                Detalhes
              </button>

              <button
                class="tab-btn"
                [class.active]="abaAtiva === 'historico'"
                (click)="abaAtiva = 'historico'"
                (click)="carregarHistorico()"
              >
                Hist√≥rico
              </button>
            </div>

            <div class="modal-body">
              <!-- üéØ ABA 1 ‚Äî DETALHES DO PEDIDO -->
              <div *ngIf="abaAtiva === 'detalhes'" class="detalhes-container">
                <div class="info-basica">
                  <p><strong>Cliente:</strong> {{ selectedPedido.clienteNome }}</p>
                  <p><strong>Status:</strong> {{ selectedPedido.status }}</p>
                  <p><strong>Total:</strong> R$ {{ selectedPedido.total.toFixed(2) }}</p>
                  <p><strong>Data:</strong> {{ formatarData(selectedPedido.dataPedido) }}</p>
                </div>

                <h3>Produtos</h3>

                <div class="produtos-container">
                  <table class="produtos-table">
                    <thead>
                      <tr>
                        <th>Produto</th>
                        <th>Qtd</th>
                        <th>Pre√ßo</th>
                      </tr>
                    </thead>

                    <tbody>
                      <!-- MODO N√ÉO EDIT√ÅVEL -->
                      @if (!isEditando) { @for (item of selectedPedido.itens; track $index) {
                      <tr>
                        <td>{{ item.produto.nome }}</td>
                        <td>{{ item.quantidade }}</td>
                        <td>R$ {{ item.precoUnitario | number : '1.2-2' }}</td>
                      </tr>
                      } }

                      <!-- MODO EDIT√ÅVEL -->
                      @if (isEditando) { @for (item of itensEditaveis; track $index) {
                      <tr>
                        <td>{{ selectedPedido.itens[$index].produto.nome }}</td>

                        <!-- quantidade edit√°vel -->
                        <td>
                          <input
                            type="number"
                            [(ngModel)]="item.quantidade"
                            min="1"
                            class="input-qtd"
                          />
                        </td>

                        <td>R$ {{ item.precoUnitario | number : '1.2-2' }}</td>
                      </tr>
                      }}
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- üéØ ABA 2 ‚Äî HIST√ìRICO DO PEDIDO -->
              @if (abaAtiva === 'historico') {
              <div>
                <h3>Hist√≥rico</h3>

                <ul class="historico-lista">
                  @for (h of historico; track $index) {
                  <li>
                    <strong>{{ formatarData(h.event_time) }}</strong> ‚Äî {{ h.event }} ‚Äî
                    {{ h.event_data }}
                  </li>
                  }
                </ul>
              </div>
              }
            </div>

            <div class="modal-footer">
              <!-- S√≥ mostra bot√µes se o pedido N√ÉO estiver cancelado -->
              @if (selectedPedido.status !== 'CANCELADO') {
              <ng-container>
                <!-- bot√£o editar -->
                @if (!isEditando) {
                <button class="btn-primary" (click)="habilitarEdicao()">Editar</button>
                }

                <!-- bot√£o confirmar edi√ß√£o -->
                @if (isEditando) {
                <button class="btn-primary" (click)="confirmarEdicao()">Confirmar</button>
                }

                <!-- bot√£o cancelar pedido -->
                <button class="btn-danger" (click)="cancelarPedido(selectedPedido!.id)">
                  Cancelar Pedido
                </button>
              </ng-container>
              }
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
